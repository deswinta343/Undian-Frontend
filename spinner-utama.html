<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <script src="https://cdn.tailwindcss.com"></script>

    <title>Undian DAOP 7</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/rb-logo.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>

    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">

        <div class="d-flex align-items-center justify-content-between">
            <i class="bi bi-list toggle-sidebar-btn"></i>
            <a href="dashboard.html" class="logo d-flex align-items-center" style="flex-grow: 1;">
                <span id="headerText" class="d-none d-lg-block" style="flex-grow: 1; white-space: nowrap;">
                    Spin And Win!
                </span>
            </a>
        </div> 

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <img src="assets/img/Logo-hd.png" alt="" style="max-width: 80px; margin-right: 20px;">
            </ul>
        </nav>
        

    </header><!-- End Header -->

    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">

        <ul class="sidebar-nav" id="sidebar-nav">

            <li class="nav-item">
                <a class="nav-link" href="dahsboard.html">
                    <i class="bi bi-house-door"></i>
                    <span>Dashboard</span>
                </a>
            </li><!-- End Dashboard Nav -->


            <li class="nav-item">
                <a class="nav-link" href="master-user.html">
                    <i class="bi bi-person-circle"></i>
                    <span>Master User</span>
                </a>
            </li><!-- End Master User Nav -->

            <li class="nav-item">
                <a class="nav-link" href="master-kandidat-HG.html">
                    <i class="bi bi-person-badge"></i>
                    <span>Master Kandidat</span>
                </a>
            </li><!-- End Master Kandidat Nav -->

            <li class="nav-item">
                <a class="nav-link" href="master-event.html">
                    <i class="bi bi-calendar-event"></i>
                    <span>Master Event</span>
                </a>
            </li><!-- End Master Event Nav -->
            <li class="nav-item">
                <a class="nav-link" href="master-doorprize.html">
                    <i class="bi bi-gift"></i>
                    <span>Master Doorprize</span>
                </a>
            </li><!-- End Master Doorprize Nav -->
            <li class="nav-item">
                <a class="nav-link " href="history.html">
                    <i class="bi bi-grid"></i>
                    <span>History Undian</span>
                </a>
            </li><!-- End Dashboard Nav -->
            <li class="nav-item">
                <a class="nav-link " href="master-customize.html">
                    <i class="bi bi-gear"></i>
                    <span>Master Header</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="signOutSidebar">
                  <i class="bi bi-box-arrow-right"></i>
                  <span>Log out</span>
                </a>
              </li><!-- End Log out Nav -->

        </ul>


    </aside><!-- End Sidebar-->

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Undian Hadiah Utama</h1>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <nav>
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="dahsboard.html">Kembali</a></li>
                        <li class="breadcrumb-item active">Hadiah Utama</li>
                    </ol>
                </nav>
            </div>
        </div>
        <section class="section">
            <div class="row">
                <div class="col-lg-3">
                    <!-- Dropdown for Events -->
                    <label for="eventDropdown" class="form-label">Pilih Event:</label>
                    <select id="eventDropdown" class="form-select">
                        <option value="">Pilih Event</option>
                    </select>
                </div>
                <div class="col-lg-3">
                    <!-- Dropdown for Hadiah Umum -->
                    <label for="hadiahDropdown" class="form-label">Pilih Hadiah:</label>
                    <select id="hadiahDropdown" class="form-select">
                        <option value="">Pilih Hadiah</option>
                    </select>
                </div>
                <div class="col-lg-3">
                    <label for="spinCount" class="form-label">Jumlah Spin:</label>
                    <div class="input-group">
                        <input type="number" id="spinCount" class="form-control" placeholder="Masukkan jumlah spin">
                    </div>
                </div>
                <div class="col-lg-3">
                    <!-- Kontainer untuk gambar -->
                    <div id="hadiahImageContainer" class="border p-2 text-center" style="height: 200px; width: 200px; overflow: hidden;">
                        <!-- Gambar hadiah -->
                        <img id="hadiahImage" src="" alt="Gambar Hadiah" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>
                
            </div>
            <div id="spinners" class="mt-3">
                <!-- Spinner Containers will be generated here -->
            </div>
            <div class="mt-3">
                <button id="startButton" class="btn btn-primary">Start</button>
                <button id="stopButton" class="btn btn-danger">Stop</button>
            </div>
            <div id="results" class="mt-3">
                <!-- Results will be displayed here -->
            </div>
            <audio id="spinSound" src="assets/sound/undianloop.mp3" loop></audio>
            <audio id="winnerSound" src="assets/sound/sound-winner.mp3"></audio>
        </section>
    </main>
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="copyright">
            &copy; Developer by <strong><span>IT INTERN KAI DAOP 7</span></strong>. All Rights Reserved
        </div>
    </footer><!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/chart.js/chart.umd.js"></script>
    <script src="assets/vendor/echarts/echarts.min.js"></script>
    <script src="assets/vendor/quill/quill.js"></script>
    <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <script>
          async function fetchHeaderText() {
        try {
            const response = await fetch('http://127.0.0.1:8000/api/customize-header/get');
            if (!response.ok) {
                throw new Error('Gagal mengambil data header');
            }
            const data = await response.json();
            
            // Cari data dengan ID 2
            const headerData = data.data.find(header => header.id === 2);
            if (headerData) {
                // Mengubah teks di elemen span
                document.getElementById('headerText').textContent = headerData.nama_header;
            } else {
                console.error('Data dengan ID 2 tidak ditemukan.');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Panggil fungsi fetch saat halaman dimuat
    window.onload = fetchHeaderText;

document.addEventListener("DOMContentLoaded", function() {
  // Ambil username dari localStorage
  const username = localStorage.getItem('username');
  
  // Cek jika username ada di localStorage
  if (username) {
    console.log("User logged in as:", username);
  } else {
    // Jika tidak ada username, redirect ke halaman login atau tampilkan pesan
    console.log("No username found. Please login.");
    window.location.href = "pages-login.html"; // Redirect ke halaman login jika diperlukan
  }

  // Sign out event listener untuk sidebar log out
  document.getElementById("signOutSidebar").addEventListener("click", function(event) {
    event.preventDefault(); // Mencegah reload halaman

    // Hapus JWT token dan username dari localStorage
    localStorage.removeItem("jwtToken");
    localStorage.removeItem("username");

    // Arahkan user ke halaman login
    window.location.href = "pages-login.html"; // Redirect ke halaman login
  });

  // Ambil user role dari localStorage
  const userRole = localStorage.getItem('role');

  // Sembunyikan menu Mastering jika user bukan Admin
  if (userRole !== 'Admin') {
    document.getElementById('mastering-menu').style.display = 'none';
  }
});

        let animationFrameId;
let kandidatData = [];
let isStopped = false;

async function fetchKandidatData() {
    try {
        // Fetch kandidat data
        const kandidatResponse = await fetch('http://127.0.0.1:8000/api/kandidat-hadiah-utama/get');
        const kandidatData = await kandidatResponse.json();

        // Fetch riwayat data
        const riwayatResponse = await fetch('http://127.0.0.1:8000/api/riwayat/riwayat');
        const riwayatData = await riwayatResponse.json();
        
        // Ambil hanya nama dari riwayat data
        const riwayatNamaList = riwayatData.data.map(riwayat => riwayat.nama);

        // Filter data kandidat
        const filteredData = kandidatData.data.filter(kandidat => {
            return kandidat.status === 'belum menang' && !riwayatNamaList.includes(kandidat.nama);
        });

        return filteredData;
    } catch (error) {
        console.error('Error fetching kandidat data:', error);
        return [];
    }
}
        function createSpinners(count) {
            const spinnersContainer = document.getElementById('spinners');
            spinnersContainer.innerHTML = '';

            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const spinnerContainer = document.createElement('div');
                spinnerContainer.className = 'spinner-container';
                spinnerContainer.innerHTML = `
         <div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>
<div class="digit-container">
    <div class="digit">0</div>
</div>

        `;
                spinnersContainer.appendChild(spinnerContainer);
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.textContent = '-';
                resultsContainer.appendChild(resultDiv);
            }
        }

        function randomDigit() {
            return Math.floor(Math.random() * 10);
        }

        function updateDigits(spinnerContainers) {
            spinnerContainers.forEach(container => {
                const digits = container.querySelectorAll('.digit');
                digits.forEach(digit => {
                    digit.textContent = randomDigit();
                });
            });
        }

        async function fetchEvents() {
            try {
                const response = await fetch('http://127.0.0.1:8000/api/event/get-event');
                const result = await response.json();

                if (result.success) {
                    const events = result.data;
                    const eventDropdown = document.getElementById('eventDropdown');

                    events.forEach(eventWrapper => {
                        const event = eventWrapper.event;
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = event.nama_event;
                        eventDropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error fetching events:', error);
            }
        }

        let hadiahList = [];

async function fetchHadiahUtama() {
    try {
        const response = await fetch('http://127.0.0.1:8000/api/doorprize/get-hadiah');
        const result = await response.json();

        if (result.success) {
            hadiahList = result.data; // Simpan seluruh data hadiah ke variabel global
            const hadiahDropdown = document.getElementById('hadiahDropdown');

            hadiahList.forEach(item => {
                if (item.kategori === 'utama') {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.nama_hadiah} - Tersedia: ${item.jumlah_sisa}`;
                    hadiahDropdown.appendChild(option);
                }
            });

            // Tambahkan event listener untuk menampilkan gambar hadiah
            hadiahDropdown.addEventListener('change', displayHadiahImage);
        }
    } catch (error) {
        console.error('Error fetching hadiah utama:', error);
    }
}
function displayHadiahImage() {
    const hadiahDropdown = document.getElementById('hadiahDropdown');
    const selectedId = hadiahDropdown.value;
    const selectedHadiah = hadiahList.find(item => item.id == selectedId);

    if (selectedHadiah && selectedHadiah.gambar) {
        const hadiahImage = document.getElementById('hadiahImage');
        // Set gambar dari hadiah yang dipilih
        hadiahImage.src = selectedHadiah.gambar.replace(/\\/g, '/');
        hadiahImage.style.display = 'block'; // Tampilkan gambar
    } else {
        document.getElementById('hadiahImage').style.display = 'none'; // Sembunyikan gambar jika tidak ada yang dipilih
    }
}


// Panggil fetchHadiahUmum untuk memuat data saat halaman dimuat
document.addEventListener('DOMContentLoaded', fetchHadiahUtama);

        fetchEvents();


        async function startSpin() {
            const spinCount = parseInt(document.getElementById('spinCount').value);
            if (isNaN(spinCount) || spinCount <= 0) {
                alert('Jumlah spin harus berupa angka positif.');
                return;
            }

            createSpinners(spinCount);

            kandidatData = await fetchKandidatData();
            if (kandidatData.length === 0) {
                alert('Data kandidat tidak ditemukan');
                return;
            }

            const spinners = document.querySelectorAll('.spinner-container');
            isStopped = false;
            const spinSound = document.getElementById('spinSound');
    spinSound.volume = 1;  // Set volume jika perlu
    spinSound.loop = true; // Pastikan sound terus berputar tanpa jeda
    spinSound.play().catch(error => {
        console.error('Error playing sound:', error);
    });

            function animate() {
                if (!isStopped) {
                    updateDigits(spinners);
                    animationFrameId = requestAnimationFrame(animate);
                }
            }
            animationFrameId = requestAnimationFrame(animate);
        }
        async function stopSpin() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        isStopped = true;

        const spinners = document.querySelectorAll('.spinner-container');
        const results = document.querySelectorAll('.result');
        const winners = [];

        results.forEach((resultDiv, index) => {
            const selectedKandidat = kandidatData[Math.floor(Math.random() * kandidatData.length)];
            winners.push({
                id: selectedKandidat.id,  // Tambahkan ID kandidat
                nipp: selectedKandidat.nipp,
                nama: selectedKandidat.nama,
                unit: selectedKandidat.unit,
            });
            resultDiv.textContent = `${selectedKandidat.nipp} - ${selectedKandidat.nama} - ${selectedKandidat.unit}`;
        });

        spinners.forEach((spinner, index) => {
            const digits = spinner.querySelectorAll('.digit');
            const nipp = winners[index]?.nipp || '00000';
            const nippString = nipp.toString().padStart(5, '0');
            digits.forEach((digit, idx) => {
                digit.textContent = nippString[idx];
            });
        });

        const spinSound = document.getElementById('spinSound');
        spinSound.pause();  // Hentikan suara
        spinSound.currentTime = 0;  // Reset waktu pemutaran ke awal

        const winnerSound = document.getElementById('winnerSound');
        winnerSound.play().catch(error => {
            console.error('Error playing winner sound:', error);
        });

        const hadiahDropdown = document.getElementById('hadiahDropdown');
        const hadiahId = hadiahDropdown.value;
        const namaHadiah = hadiahDropdown.options[hadiahDropdown.selectedIndex].text.split(' - ')[0];

        const eventId = document.getElementById('eventDropdown').value;
        const jumlahSpin = parseInt(document.getElementById('spinCount').value);

        if (hadiahId && eventId && !isNaN(jumlahSpin)) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/doorprize/update-jumlah-keluar/${hadiahId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jumlah_keluar: jumlahSpin
                    })
                });

                const result = await response.json();
                if (result.success) {
                    console.log('Jumlah keluar hadiah telah diperbarui.');

                    // Kumpulkan semua winner IDs
                    const winnerIds = winners.map(winner => winner.id);

                    // Ubah status semua kandidat sekaligus
                    const updateStatusResponse = await fetch('http://127.0.0.1:8000/api/kandidat-hadiah-utama/edit-status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            winner_ids: winnerIds, // Kirim array ID
                            status: 'sudah menang'
                        })
                    });

                    const updateStatusResult = await updateStatusResponse.json();
                    if (updateStatusResult.success) {
                        console.log('Status semua pemenang telah diubah menjadi sudah menang.');
                    } else {
                        console.error('Gagal mengubah status pemenang:', updateStatusResult.message);
                    }

                    // Kirim semua data riwayat dalam satu permintaan (bulk insert)
                    const riwayatData = winners.map(winner => ({
                        event_id: eventId,
                        doorprize_id: hadiahId,
                        pemenang: winner.nama,
                        nipp: winner.nipp,
                        unit: winner.unit,
                        nama_hadiah: namaHadiah,
                    }));

                    const riwayatResponse = await fetch('http://127.0.0.1:8000/api/riwayat/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            riwayat: riwayatData // Kirim array riwayat dalam satu request
                        })
                    });

                    const riwayatResult = await riwayatResponse.json();
                    if (riwayatResult.success) {
                        console.log('Riwayat pemenang berhasil disimpan.');
                    } else {
                        console.error('Gagal menyimpan riwayat pemenang:', riwayatResult.message);
                    }
                } else {
                    console.error('Gagal memperbarui jumlah keluar:', result.message);
                }
            } catch (error) {
                console.error('Error saat mengupdate jumlah keluar atau status pemenang:', error);
            }
        } else {
            alert('Hadiah, event, atau jumlah spin tidak valid.');
        }
    }
}

      document.getElementById('startButton').addEventListener('click', startSpin);
        document.getElementById('stopButton').addEventListener('click', stopSpin);

          </script>
    <style>
        .digit-container {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            background-color: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 40px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .digit {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #spinners {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result {
            margin-top: 10px;
            font-size: 1.5rem;
            color: rgb(31, 31, 128);
        }
    </style>


</body>

</html>